#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#       __________  __ ___       _____    ________            
#      / ____/ __ \/ // / |     / /   |  /  _/ __ \____  _____
#     / /   / /_/ / // /| | /| / / /| |  / // / / / __ \/ ___/
#    / /___/ ____/__  __/ |/ |/ / ___ |_/ // /_/ / /_/ (__  ) 
#    \____/_/      /_/  |__/|__/_/  |_/___/\____/ .___/____/  
#                                              /_/            
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#---------------------------------------------------------------------------------------------------------------------------------------------------"
#  Installing CP4WAIOPS 3.2
#
#  CloudPak for Watson AIOps
#
#  ¬©2021 nikh@ch.ibm.com
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
clear
echo "  "
echo "  "
echo "  "
echo "  "
echo "  "
echo "  "
echo "  "
echo "  "
echo "  "
echo "  "
echo "  "
echo "  "
echo "  "
echo "  "
echo "  "
echo "  "
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo "      __________  __ ___       _____    ________            "
echo "     / ____/ __ \/ // / |     / /   |  /  _/ __ \____  _____"
echo "    / /   / /_/ / // /| | /| / / /| |  / // / / / __ \/ ___/"
echo "   / /___/ ____/__  __/ |/ |/ / ___ |_/ // /_/ / /_/ (__  ) "
echo "   \____/_/      /_/  |__/|__/_/  |_/___/\____/ .___/____/  "
echo "                                             /_/            "
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo "  "
echo "  üöÄ CloudPak for Watson AIOps 3.2 - AI MANAGER Install "
echo "  "
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo "  "
echo "  "
echo ""
echo ""
echo ""
echo ""
echo ""




echo "***************************************************************************************************************************************************"
echo "  "
echo "  üöÄ Starting installation"
echo "  "
echo "***************************************************************************************************************************************************"

echo "  "
echo "***************************************************************************************************************************************************"
echo "  üì• Create Namespace"
oc create ns argocd

echo "  "
echo "***************************************************************************************************************************************************"
echo "  üì• Create Openshift GitOps Operator"
oc apply -n openshift-operators -f ./argocd/install/1_argocd_sub.yaml


while : ; do
    READY=$(oc get ClusterServiceVersion -n openshift-operators || true) 
    if [[ ! $READY  =~ "Succeeded" ]]; then
        echo "   üï¶ Openshift GitOps Operator is not ready. Waiting for 10 seconds...." && sleep 10; 
    else
        echo "      ‚úÖ OK"
        break
    fi
done

echo "  "
echo "***************************************************************************************************************************************************"
echo "  üì• Create Openshift GitOps Instance"
oc create clusterrolebinding argocd-admin --clusterrole=cluster-admin --serviceaccount=argocd:argocd-argocd-application-controller
oc create clusterrolebinding default-admin --clusterrole=cluster-admin --serviceaccount=cp4waiops:default
oc apply -n  openshift-gitops -f ./argocd/install/2_argocd_install.yaml


while : ; do
    READY=$(oc get ArgoCD -n openshift-gitops openshift-gitops -o jsonpath={.status}|| true) 
    if [[ ! $READY  =~ '"server":"Running"' ]]; then
        echo "   üï¶ Openshift GitOps Instance is not ready. Waiting for 10 seconds...." && sleep 10; 
    else
        echo "      ‚úÖ OK"
        break
    fi
done



echo "  "
echo "***************************************************************************************************************************************************"
echo "  üîê Login Credentials"
echo "  "
echo "            üåè URL:      https://$(oc get route -n  openshift-gitops  openshift-gitops-server -o jsonpath={.spec.host})"
echo "  "
echo "            üßî User:       admin"
echo "            üîê Password:   "$(oc get secret -n openshift-gitops openshift-gitops-cluster -o "jsonpath={.data['admin\.password']}"| base64 --decode)
echo "  "




